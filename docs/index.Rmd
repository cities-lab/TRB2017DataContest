---
title: "Visualization and Modeling of AirSage Trips Data"
author: "Huajie Yang, Wei Shi, Yi Wang, and Liming Wang (Faculty Advisor)"
date: "12/15/2016"
output: html_document
bibliography: references.bib
---

## Abstract

## Introduction
1. Intro of AirSage Data

2. Describe what we have done

This paper is available on [github](https://cities-lab.github.io/TRB2017DataContest/). We follow the practice of reproducible research [@Gandrud2015] for our work and our writing-up is fully reproducible from a Rmarkdown file and R scripts, the source of which is available on our github repository at https://github.com/cities-lab/TRB2017DataContest (the data files are withheld according to AirSage's confidentiality agreement).


```{r setup, include=FALSE}
if (!require("pacman")) {install.packages("pacman"); library(pacman)}
p_load(dplyr, gridExtra, ggplot2, knitr, printr, scales, magrittr, 
       stargazer, readr, pander, stringr, ggmap, maptools)
p_load_gh("rstudio/leaflet", "dgrtwo/gganimate")

#opts_knit$set(root.dir = here(".."))
knitr::opts_knit$set(root.dir = normalizePath("..")) 
opts_chunk$set(echo=FALSE, message=FALSE, warning=F)
options(scipen=100)
options(digits=3)
```

```{r source, include=F}
source("code/functions.R")
source("code/load_data.R")
source("code/agg_sld.R")
```

## Visualization
### Trip Purpose
```{r}
trips.date_hour_purpose <- trips.df %>% 
  #filter(Start_Weekday) %>% 
  group_by(Start_Date, Start_Hour, Purpose) %>% 
  summarize(trips=sum(Count),
            Start_Day=first(Start_Day),
            Start_Weekend=first(Start_Weekend)) %>% 
  I(#trips_scaled=rescale(trips),
         #Start_Day=format(Start_Date, "%a"),
         #Start_Weekend=ifelse(Start_Day %in% c("Sun", "Sat"), "Weekend", "Weekday"),
         #Start_Day=factor(Start_Day, levels=c("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"))
         ) %>% 
  ungroup()

ggplot(data=trips.date_hour_purpose, aes(x=Start_Hour, y=trips, colour=Purpose, group=Purpose)) +
  #geom_area(position = 'stack') +
  stat_smooth() + ylim(0, 500000) +
  facet_wrap(~Start_Day)
  #scale_y_continuous(labels = percent) +
  #labs(x="standard dev of residuals", y="Normalized mean error") +
  #scale_colour_discrete(guide=FALSE) +
  #scale_y_log10()

ggplot(data=trips.date_hour_purpose, aes(x=Start_Hour, y=trips, colour=Purpose, group=Purpose)) +
  #geom_area(position = 'stack') +
  stat_smooth() + ylim(0, 500000) +
  facet_wrap(~Start_Weekend)

trips.date_hour_purpose %<>% 
  group_by(Start_Date, Purpose) %>% 
  mutate(trips_scaled=scale(trips))

base_size <- 9
(p <- ggplot(trips.date_hour_purpose, aes(Start_Hour, Start_Date)) + geom_tile(aes(fill = trips_scaled),
     colour = "white") + scale_fill_gradient(low = "white", high = "red") + 
     # theme_grey(base_size = base_size) + labs(x = "", y = "") + 
     # scale_x_discrete(expand = c(0, 0)) + scale_y_discrete(expand = c(0, 0)) + 
     # theme(legend.position = "none", axis.ticks = element_blank(), 
     #      axis.text.x = element_text(size = base_size * 0.8, angle = 330, 
     #                               hjust = 0, colour = "grey50"))    +
    facet_wrap(~Purpose)
    )
```

### Subscriber Class
Figure 1 displays trip frequencies for nine trip purposes by time-of-day and day of the week. Trip frequency for O-O (OO) purpose is substantially higher than trip frequencies for other trip purposes. It makes sense because other locations include locations except home and work place. The second largest number of trips are made for (Home to Home) HH. The trip frequencies for Home to Work (HW), (Home to Other) HO and (Other to Home) OH are a little less than trip frequency for HH. The lowest number of trips is made for Work to Work (WW) purpose. The trip frequency for Work to Other (WO) is higher than that for WW, and less than trip frequency for Work to Home (WH). 

The distribution of trip frequency for OO purpose are similar on days of the week: trip frequency appears around noon and peak of trip frequency is about 45, 000.  All work related trips (WO, WH, WW, OW and HW) show clear temporal patterns: trip frequencies on weekend are much less than on weekday; peak of trips that originating at home (HW) appears in the morning; peak of trips that ending at home (WH) appears at the afternoon. The peak of HH appears around noon on weekend, and appears before and after noon. The peak of WH is much lower than that of HW, because people are nor all going back home after work, which is shown in figure: peak of WO appears around 17:30 PM on weekdays. 
The shadow around the solid line shows the variance of trip frequency. As shown in Figure 1, the variance of OO trip frequency is the highest, followed by HW, HH, HO and WH trips. Variance of OH, WO and OW trip frequency are not obvious. The variances of work-related (WO, WH, WW, OW, HW) trip frequency on weekdays is larger than those on weekend. The difference in variance between weekday and weekend seems to make sense that much less HW trips are made during weekend than during weekday. 

Figure 2 displays trip frequency for nine trip purposes over time-of-day on weekday and weekend. There is least difference in trip frequency for OO purpose between weekday and weekend. For work related trips, trip frequency on weekend is much less than that on weekday. This makes sense that few people go to work places during weekend. The distribution of HH trips are quite different on weekday and weekend: there are two peaks of trip frequency for HH purpose on weekday, while there is only one sharp peak on weekend. For OH trips, there are higher trip frequency during 0:00 pm to 5:00 pm on weekend than on weekday. This makes sense that people are more likely to go back home during 0:00 pm to 5:00 pm on weekend than on weekday. 

Figure 3 displays trip frequency for nine trip purposes by time-of-day and date of April 2014. Each rectangle in Figure 3 represents scaled trip frequency for certain purpose during one hour period of certain day. Figure 3 further shows that there are no obvious difference in trip frequency for WW, OO and OH purposes between weekday and weekend. Most obvious difference in trip frequency between weekday and weekend are OW, WO, WH and HW trips. Just as Figure 3 shows, HW and WH trips on weekend are made later than those made on weekdays. This indicates that people go to work later on weekend than on weekday and they also leave later on weekend than weekday. They spend same time period on working during weekend as during weekday. This implies that employees are glad to spend same time on work and have more flexible schedule. There are also differences in trip frequency for HH and HO between weekday and weekend, but they are not obvious as WW, OO and OH trips. Figure 3 shows there is almost no difference between two days if they are both weekday or weekend no matter what dates they are. This implies that date of month does not influence travel behavior. One exception is April 18th, which is Friday but its trip frequency for HO is similar to weekend, because April 20th is the Easter and April 18th is Good Friday. 

```{r}
trips.date_hour_class <- trips.df %>% 
  #filter(Start_Weekday) %>% 
  group_by(Start_Date, Start_Hour, Subscriber_Class) %>% 
  summarize(trips=sum(Count)) %>% 
  mutate(trips_scaled=rescale(trips),
         Start_Day=format(Start_Date, "%a"),
         Start_Weekend=ifelse(Start_Day %in% c("Sun", "Sat"), "Weekend", "Weekday"),
         Start_Day=factor(Start_Day, levels=c("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"))
         ) %>% 
  ungroup()

ggplot(data=trips.date_hour_class, aes(x=Start_Hour, y=trips, colour=Subscriber_Class, group=Subscriber_Class)) +
  #geom_area(position = 'stack') +
  stat_smooth() + ylim(0, 500000) +
  facet_wrap(~Start_Day)
  #scale_y_continuous(labels = percent) +
  #labs(x="standard dev of residuals", y="Normalized mean error") +
  #scale_colour_discrete(guide=FALSE) +
  #scale_y_log10()

ggplot(data=trips.date_hour_class, aes(x=Start_Hour, y=trips, colour=Subscriber_Class, group=Subscriber_Class)) +
  #geom_area(position = 'stack') +
  stat_smooth() + ylim(0, 500000) +
  facet_wrap(~Start_Weekend)

trips.date_hour_class %<>% 
  group_by(Start_Date, Subscriber_Class) %>% 
  mutate(trips_scaled=scale(trips))
```

Comparing the travel pattern differences among subscriber classes, we found that short term visitors made the most trips, followed by long term visitors, resident workers and home workers, whereas there were relatively less trips made by inbound and outbound commuters. In terms of time of day, the trip count was an apparent inverse U curve indicating more trips were made in daytime, with PM peak trend for resident workers. All subscriber classes seemed to have late starts in the mornings and early ends in the evenings in weekends than weekdays. Resident workers made relatively more trips in late afternoon time, possibly after-work errand trips, in the weekdays than weekends.

As there were significant differences between weekdays and weekends, we closely compare the travel pattern differences between weekdays and weekends among different subscriber classes. It was clear that almost all subscriber class, except long term visitors made more trips in weekdays than in weekends. The resident workers' travel patterns of more late afternoon trips in weekdays was more apparent in the weekend/weekday comparison graph. In addition, the variation of trip generation, represented by the grey shady areas around the lines, were bigger in weekends than weekdays, indicating trips generation in weekends were less predictable than weekdays.


```{r}
(p <- ggplot(trips.date_hour_class, aes(Start_Hour, Start_Date)) + geom_tile(aes(fill = trips_scaled),
     colour = "white") + scale_fill_gradient(low = "white", high = "red") + 
    facet_wrap(~Subscriber_Class)
    )
```

```{r animation}
# first compute culumative trips
trips.d1 <- trips.df %>% 
  filter(Start_Date=="2014-04-01")

cumtrips.out <- trips.d1 %>%   
  group_by(Origin_Zone, Start_Hour) %>% 
  summarize(trips=sum(Count)) %>% 
  mutate(cumtrips.out=cumsum(trips)) %>% 
  select(Origin_Zone, Start_Hour, cumtrips.out)

cumtrips.in <- trips.d1 %>%   
  group_by(Destination_Zone, Start_Hour) %>% 
  summarize(trips=sum(Count)) %>% 
  mutate(cumtrips.in=cumsum(trips)) %>% 
  select(Destination_Zone, Start_Hour, cumtrips.in)
  
cumtrips <- cumtrips.in %>% 
  left_join(cumtrips.out, 
            by=c("Destination_Zone"="Origin_Zone", "Start_Hour"="Start_Hour")) %>% 
  mutate(cumtrips=cumtrips.in - cumtrips.out,
         cumtrips=ifelse(cumtrips<0, 0, cumtrips),
         id=as.character(Destination_Zone))

spdf.cumtrips <- spdf.ff %>% 
  left_join(cumtrips, by=c("id"="id"))

map <- ggplot() + geom_polygon(aes(x = long, y = lat, group=group, fill=cumtrips),
                               data = spdf.cumtrips, color ="black", 
                               size = 0) +
  coord_map()+
  scale_fill_distiller(name="trips arrived", palette = "RdBu", breaks = pretty_breaks(n = 5))+
  theme_nothing(legend = TRUE)
map

require(gganimate)
theme_set(theme_bw())
p <- ggplot() + geom_polygon(aes(x = long, y = lat, group=group, fill=cumtrips, frame=Start_Hour),
                               data = spdf.cumtrips, color ="black", 
                               size = 0) +
    coord_map()+
    scale_fill_distiller(name="trips arrived", palette = "RdBu", breaks = pretty_breaks(n = 5))
gg_animate(p)
```

```{r ggmaps}


shpfile <- 'data/taz/OUATS_AirSage_TAZ.shp'
spdf <- read.shpfile(shpfile)

spdf.ff <- fortify(spdf, region="TAZ_ID")
spdf.ff %<>% left_join(m0401.o, by=c("id"="TAZ_ID"))

map <- ggplot() + geom_polygon(aes(x = long, y = lat, group=group, fill=trips),
                               data = spdf.ff, color ="black", 
                               size = 0) +
  coord_map()+
  scale_fill_distiller(name="trips originated", palette = "RdBu", breaks = pretty_breaks(n = 5))+
  theme_nothing(legend = TRUE)
map
```


```{r leaflet_maps}
spdf@data %<>% left_join(m0401.o %>% mutate(TAZ_ID=as.integer(TAZ_ID)))
pal.qtl <- colorQuantile(palette = "YlOrRd", domain = spdf@data$trips)
pal.num <- colorNumeric (palette = "YlOrRd", domain = spdf@data$trips)
leaflet(spdf) %>%
  addPolygons(
    stroke = FALSE, fillOpacity = 0.5, smoothFactor = 0.5,
    fillColor = ~pal.qtl(trips),
    label=~stringr::str_c(
                TAZ_ID,' ',
                formatC(trips, big.mark = ',', format='d')),
    labelOptions= labelOptions(direction = 'auto'),
    highlightOptions = highlightOptions(
                color='#ff0000', opacity = 1, weight = 2, fillOpacity = 1,
                bringToFront = TRUE, sendToBack = TRUE)
  )
```

## References
<! -- Gandrud, C., 2015. Reproducible Research with R and R Studio, Second Edition, 2 edition. ed. Chapman and Hall/CRC, Boca Raton. -->


<!--## Session Info-->
```{r session_info}
#pander(devtools::session_info())
```