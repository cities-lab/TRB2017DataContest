---
title: "Visualize Temporal and Spatial Patterns of AirSage Trips Data"
author: "Huajie Yang, Wei Shi, Yi Wang, and Liming Wang (Faculty Advisor)"
date: "12/15/2016"
output: html_document
bibliography: "references.bib"
---

## Abstract

## Introduction
1. Intro of AirSage Data

2. Describe what we have done

This paper is available on [github](https://cities-lab.github.io/TRB2017DataContest/). We follow the practice of reproducible research [@Gandrud2015] for our work and our writing-up is fully reproducible from a Rmarkdown file and R scripts, the source code of which is available on our github repository at https://github.com/cities-lab/TRB2017DataContest (the data files are withheld according to AirSage's confidentiality agreement).


```{r setup, include=FALSE}
if (!require("pacman")) {install.packages("pacman"); library(pacman)}
p_load(dplyr, gridExtra, ggplot2, knitr, printr, scales, magrittr, 
       stargazer, readr, pander, stringr, ggmap, maptools)
p_load_gh("rstudio/leaflet", "dgrtwo/gganimate")

#opts_knit$set(root.dir = here(".."))
knitr::opts_knit$set(root.dir = normalizePath("..")) 
opts_chunk$set(echo=FALSE, message=FALSE, warning=F)
options(scipen=100)
options(digits=3)
```

```{r source, include=F, cache=TRUE}
source("code/functions.R")
source("code/load_data.R")
source("code/agg_sld.R")
source("code/do_map.R")
```

## Visualization
### Trip Purpose
```{r}
trips.date_hour_purpose <- trips.df %>% 
  #filter(Start_Weekday) %>% 
  group_by(Start_Date, Start_Hour, Purpose) %>% 
  summarize(trips=sum(Count),
            Start_Day=first(Start_Day),
            Start_Weekend=first(Start_Weekend)) %>% 
  I(#trips_scaled=rescale(trips),
         #Start_Day=format(Start_Date, "%a"),
         #Start_Weekend=ifelse(Start_Day %in% c("Sun", "Sat"), "Weekend", "Weekday"),
         #Start_Day=factor(Start_Day, levels=c("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"))
         ) %>% 
  ungroup()

ggplot(data=trips.date_hour_purpose, aes(x=Start_Hour, y=trips, colour=Purpose, group=Purpose)) +
  #geom_area(position = 'stack') +
  stat_smooth() + ylim(0, 500000) +
  facet_wrap(~Start_Day)
  #scale_y_continuous(labels = percent) +
  #labs(x="standard dev of residuals", y="Normalized mean error") +
  #scale_colour_discrete(guide=FALSE) +
  #scale_y_log10()

ggplot(data=trips.date_hour_purpose, aes(x=Start_Hour, y=trips, colour=Purpose, group=Purpose)) +
  #geom_area(position = 'stack') +
  stat_smooth() + ylim(0, 500000) +
  facet_wrap(~Start_Weekend)

trips.date_hour_purpose %<>% 
  group_by(Start_Date, Purpose) %>% 
  mutate(trips_scaled=scale(trips))

base_size <- 9
(p <- ggplot(trips.date_hour_purpose, aes(Start_Hour, Start_Date)) + geom_tile(aes(fill = trips_scaled),
     colour = "white") + scale_fill_gradient(low = "white", high = "red") + 
     # theme_grey(base_size = base_size) + labs(x = "", y = "") + 
     # scale_x_discrete(expand = c(0, 0)) + scale_y_discrete(expand = c(0, 0)) + 
     # theme(legend.position = "none", axis.ticks = element_blank(), 
     #      axis.text.x = element_text(size = base_size * 0.8, angle = 330, 
     #                               hjust = 0, colour = "grey50"))    +
    facet_wrap(~Purpose)
    )
```

### Subscriber Class
```{r}
trips.date_hour_class <- trips.df %>% 
  #filter(Start_Weekday) %>% 
  group_by(Start_Date, Start_Hour, Subscriber_Class) %>% 
  summarize(trips=sum(Count)) %>% 
  mutate(trips_scaled=rescale(trips),
         Start_Day=format(Start_Date, "%a"),
         Start_Weekend=ifelse(Start_Day %in% c("Sun", "Sat"), "Weekend", "Weekday"),
         Start_Day=factor(Start_Day, levels=c("Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"))
         ) %>% 
  ungroup()

ggplot(data=trips.date_hour_class, aes(x=Start_Hour, y=trips, colour=Subscriber_Class, group=Subscriber_Class)) +
  #geom_area(position = 'stack') +
  stat_smooth() + ylim(0, 500000) +
  facet_wrap(~Start_Day)
  #scale_y_continuous(labels = percent) +
  #labs(x="standard dev of residuals", y="Normalized mean error") +
  #scale_colour_discrete(guide=FALSE) +
  #scale_y_log10()

ggplot(data=trips.date_hour_class, aes(x=Start_Hour, y=trips, colour=Subscriber_Class, group=Subscriber_Class)) +
  #geom_area(position = 'stack') +
  stat_smooth() + ylim(0, 500000) +
  facet_wrap(~Start_Weekend)

trips.date_hour_class %<>% 
  group_by(Start_Date, Subscriber_Class) %>% 
  mutate(trips_scaled=scale(trips))
```

```{r}
(p <- ggplot(trips.date_hour_class, aes(Start_Hour, Start_Date)) + geom_tile(aes(fill = trips_scaled),
     colour = "white") + scale_fill_gradient(low = "white", high = "red") + 
    facet_wrap(~Subscriber_Class)
    )
```
Net
```{r maps, include=F}
# first compute culumative trips
do_animation(trips.df, "Weekday")
do_animation(trips.df, "Weekend")

# alternatively, create static maps every 4 hours
# map.wdh04 <- do_map(cumtrips, Weekend="Weekday", Hour=4)
# map.wdh08 <- do_map(cumtrips, Weekend="Weekday", Hour=8)
# map.wdh12 <- do_map(cumtrips, Weekend="Weekday", Hour=12)
# map.wdh16 <- do_map(cumtrips, Weekend="Weekday", Hour=16)
# map.wdh20 <- do_map(cumtrips, Weekend="Weekday", Hour=20)
# map.wdh24 <- do_map(cumtrips, Weekend="Weekday", Hour=24)
# grid.arrange(map.wdh04, map.wdh08, map.wdh12, map.wdh16, map.wdh20, map.wdh24, ncol=2)
# 
# map.weh04 <- do_map(cumtrips, Weekend="Weekend", Hour=4)
# map.weh08 <- do_map(cumtrips, Weekend="Weekend", Hour=8)
# map.weh12 <- do_map(cumtrips, Weekend="Weekend", Hour=12)
# map.weh16 <- do_map(cumtrips, Weekend="Weekend", Hour=16)
# map.weh20 <- do_map(cumtrips, Weekend="Weekend", Hour=20)
# map.weh24 <- do_map(cumtrips, Weekend="Weekend", Hour=24)
# grid.arrange(map.weh04, map.weh08, map.weh12, map.weh16, map.weh20, map.weh24, ncol=2)
```

![Net Average Weekday Daily Trips by Hour ]("/docs/map_animation.Weekday.gif")
![Net Average Weekend Daily Trips by Hour ]("/docs/map_animation.Weekend.gif")

## References
<! -- Gandrud, C., 2015. Reproducible Research with R and R Studio, Second Edition, 2 edition. ed. Chapman and Hall/CRC, Boca Raton. -->


<!--## Session Info-->
```{r session_info}
#pander(devtools::session_info())
```